{% extends "base.html" %}
{% set active = 'appointments' %}

{% block extra_css %}
<link rel="stylesheet" href="{{ static_url('css/pages/appointments.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Botón para abrir el modal -->
    <div class="mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Citas</h1>
        <button onclick="openNewAppointmentModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
            <i class="fas fa-plus mr-2"></i>Nueva Cita
        </button>
    </div>

    <!-- Modal para nueva cita -->
    <div id="newAppointmentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Nueva Cita</h3>
                <form id="appointmentForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="patient_id">
                            Paciente *
                        </label>
                        <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="patient_id" name="patient_id" required>
                            <option value="">Seleccionar paciente...</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="date">
                            Fecha y Hora *
                        </label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="date" name="date" type="datetime-local" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="service_type">
                            Tipo de Servicio *
                        </label>
                        <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="service_type" name="service_type" required>
                            <option value="">Seleccionar servicio...</option>
                            <option value="CONSULTA">Consulta General</option>
                            <option value="LIMPIEZA">Limpieza Dental</option>
                            <option value="TRATAMIENTO">Tratamiento</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="notes">
                            Notas
                        </label>
                        <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelAppointmentButton"
                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                            Cancelar
                        </button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabla de citas -->
    <div class="bg-white shadow-md rounded my-6">
        <table class="min-w-full">
            <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">Paciente</th>
                    <th class="py-3 px-6 text-left">Fecha y Hora</th>
                    <th class="py-3 px-6 text-left">Servicio</th>
                    <th class="py-3 px-6 text-center">Estado</th>
                    <th class="py-3 px-6 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for appointment in appointments %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="font-medium">{{ appointment.patient.name }}</span>
                        </div>
                    </td>
                    <td class="py-3 px-6 text-left">
                        {{ appointment.date.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="py-3 px-6 text-left">
                        {% set service_names = {
                            'CONSULTA': 'Consulta General',
                            'LIMPIEZA': 'Limpieza Dental',
                            'TRATAMIENTO': 'Tratamiento'
                        } %}
                        {{ service_names[appointment.service_type] }}
                    </td>
                    <td class="py-3 px-6 text-center">
                        <span class="px-3 py-1 text-sm rounded-full 
                            {% if appointment.status == 'SCHEDULED' %}bg-blue-100 text-blue-800
                            {% elif appointment.status == 'COMPLETED' %}bg-green-100 text-green-800
                            {% elif appointment.status == 'CANCELLED' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {% set status_names = {
                                'SCHEDULED': 'Programada',
                                'COMPLETED': 'Completada',
                                'CANCELLED': 'Cancelada'
                            } %}
                            {{ status_names[appointment.status] }}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center">
                            {% if appointment.status == 'SCHEDULED' %}
                            <button onclick="cancelAppointment({{ appointment.id }})" 
                                class="w-4 mr-2 transform hover:text-red-500 hover:scale-110">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                            <button onclick="viewAppointment({{ appointment.id }})" 
                                class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar el formulario
    const appointmentForm = document.getElementById('appointmentForm');
    
    function openNewAppointmentModal() {
        document.getElementById('newAppointmentModal').classList.remove('hidden');
        
        // Establecer fecha mínima como hoy
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Ajustar zona horaria
        const today = now.toISOString().slice(0, 16);
        
        const dateInput = document.getElementById('date');
        dateInput.min = today;
        dateInput.value = today; // Establecer fecha actual como valor predeterminado
    }

    function closeNewAppointmentModal() {
        document.getElementById('newAppointmentModal').classList.add('hidden');
        appointmentForm.reset();
    }

    // Asignar la función al objeto window para que esté disponible globalmente
    window.openNewAppointmentModal = openNewAppointmentModal;
    window.closeNewAppointmentModal = closeNewAppointmentModal;

    // Botón de cancelar en el modal
    document.getElementById('cancelAppointmentButton').addEventListener('click', closeNewAppointmentModal);

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('newAppointmentModal');
        if (event.target == modal) {
            closeNewAppointmentModal();
        }
    };

    // Manejar el envío del formulario
    appointmentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const dateInput = document.getElementById('date').value;
        const formData = {
            patient_id: document.getElementById('patient_id').value,
            date: new Date(dateInput).toISOString(),
            service_type: document.getElementById('service_type').value,
            notes: document.getElementById('notes').value
        };

        try {
            const response = await fetch('/api/appointments/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                closeNewAppointmentModal();
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al crear la cita');
        }
    });
});

// Funciones globales para las acciones de la tabla
async function cancelAppointment(id) {
    if (!confirm('¿Estás seguro de que deseas cancelar esta cita?')) {
        return;
    }

    try {
        const response = await fetch(`/api/appointments/${id}/cancel`, {
            method: 'PUT'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error al cancelar la cita');
    }
}

function viewAppointment(id) {
    // Implementar vista detallada de la cita
    console.log('Ver cita:', id);
}
</script>
{% endblock %}